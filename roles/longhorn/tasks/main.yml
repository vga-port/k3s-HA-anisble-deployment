---
- name: Ensure Longhorn namespace exists
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ longhorn_namespace }}"
  when: longhorn_enabled

- name: Add Longhorn Helm repository
  kubernetes.core.helm_repository:
    kubeconfig: "{{ kubeconfig_path }}"
    name: longhorn
    repo_url: "https://charts.longhorn.io"
  when: longhorn_enabled

- name: Deploy Longhorn via Helm
  kubernetes.core.helm:
    kubeconfig: "{{ kubeconfig_path }}"
    name: longhorn
    chart_ref: longhorn/longhorn
    chart_version: "{{ longhorn_version }}"
    release_namespace: "{{ longhorn_namespace }}"
    create_namespace: true
    values:
      defaultSettings:
        defaultReplicaCount: "{{ longhorn_replica_count }}"
        storageClass:
          - name: "{{ longhorn_storage_class }}"
            defaultClass: "{{ longhorn_default_storage_class }}"
        backupTarget: "{{ longhorn_backup_target }}"
        backupTargetCredentialSecret: "{{ longhorn_backup_target_credential_secret }}"
        recurringJobs:
          enabled: "{{ longhorn_recurring_jobs_enabled }}"
        autoDeletePodWhenVolumeDetached: "{{ longhorn_auto_delete_pod_when_volume_detached }}"
        disableRevisionCounter: "{{ longhorn_disable_revision_counter }}"
        defaultFsType: "{{ longhorn_fs_type }}"
        mkfsOptions: "{{ longhorn_mkfs_options }}"
        mountOptions: "{{ longhorn_mount_options }}"
        storageOverCommitment: "{{ longhorn_storage_over_commitment }}"
        storageAvailable: "{{ longhorn_storage_available }}"
        storageReserved: "{{ longhorn_storage_reserved }}"
      longhornUI:
        enabled: "{{ longhorn_ui_enabled }}"
        service:
          type: "{{ longhorn_ui_service_type }}"
      nodeSelector: "{{ longhorn_node_selector | to_json }}"
      tolerations: "{{ longhorn_tolerations | to_json }}"
      defaultResources:
        requests:
          cpu: "{{ longhorn_default_cpu_requests }}"
          memory: "{{ longhorn_default_memory_requests }}"
        limits:
          cpu: "{{ longhorn_default_cpu_limits }}"
          memory: "{{ longhorn_default_memory_limits }}"
    wait: true
    timeout: 10m
  when: longhorn_enabled

- name: Wait for Longhorn to be ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: apps/v1
    kind: Deployment
    name: longhorn-manager
    namespace: "{{ longhorn_namespace }}"
    wait_condition:
      type: Available
      status: "True"
      reason: MinimumReplicasAvailable
    wait_timeout: 300
  register: longhorn_deployment
  retries: 10
  delay: 30
  when: longhorn_enabled

- name: Verify Longhorn storage class
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: "{{ longhorn_storage_class }}"
  register: longhorn_sc
  failed_when: not longhorn_sc.resources
  when: longhorn_enabled and longhorn_default_storage_class

- name: Display Longhorn access information
  debug:
    msg: |
      Longhorn has been deployed successfully!
      Storage Class: {{ longhorn_storage_class }}
      UI: kubectl port-forward -n {{ longhorn_namespace }} svc/longhorn-ui 8000:80
      Then access: http://localhost:8000
  when: longhorn_enabled